import streamlit as st
import os

# --- 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤ (Database ‡∏Å‡∏•‡∏≤‡∏á) ---
all_courses_db = {
    # ‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤: [‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï, "‡∏ß‡∏±‡∏ô‡∏™‡∏≠‡∏ö", "‡∏Ñ‡∏≤‡∏ö", "‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤", "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"]
    "RAM1101": [3, "4", "A", "‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢", "RAM"], "RAM1111": [3, "4", "B", "‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© 1", "RAM"],
    "RAM1112": [3, "3", "B", "‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© 2", "RAM"], "RAM1132": [3, "3", "A", "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î", "RAM"],
    "RAM1141": [3, "2", "A", "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û", "RAM"], "RAM1204": [3, "3", "B", "‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î", "RAM"],
    "RAM1213": [3, "3", "A", "‡∏ß‡∏¥‡∏ä‡∏≤ RAM", "RAM"], "RAM1301": [3, "4", "B", "‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏°", "RAM"],
    "RAM1303": [3, "2", "B", "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", "RAM"], "RAM1312": [3, "4", "B", "‡∏ß‡∏¥‡∏ä‡∏≤ RAM", "RAM"],
    "LAW1101": [2, "2", "A", "‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏°‡∏´‡∏≤‡∏ä‡∏ô", "LAW"], "LAW1102": [2, "4", "A", "‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô", "LAW"],
    "LAW1103": [3, "2", "A", "‡∏ô‡∏¥‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°", "LAW"], "LAW2101": [3, "2", "B", "‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå", "LAW"],
    "LAW2102": [3, "3", "A", "‡∏´‡∏ô‡∏µ‡πâ", "LAW"], "LAW2104": [3, "2", "B", "‡∏£‡∏±‡∏ê‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç", "LAW"],
    "LAW2105": [3, "4", "A", "‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢", "LAW"], "LAW2106": [3, "4", "A", "‡∏≠‡∏≤‡∏ç‡∏≤ 1", "LAW"],
    "LAW2107": [3, "1", "B", "‡∏≠‡∏≤‡∏ç‡∏≤ 2", "LAW"], "LAW2109": [3, "3", "B", "‡∏¢‡∏∑‡∏° ‡∏ù‡∏≤‡∏Å", "LAW"],
    "LAW2110": [2, "1", "B", "‡∏Ñ‡πâ‡∏≥ ‡∏à‡∏≥‡∏ô‡∏≥", "LAW"], "LAW2111": [2, "3", "A", "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô", "LAW"],
    "LAW2112": [2, "4", "B", "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô", "LAW"], "LAW2113": [3, "2", "A", "‡∏ï‡∏±‡πã‡∏ß‡πÄ‡∏á‡∏¥‡∏ô", "LAW"],
    "LAW2108": [2, "1", "A", "‡πÄ‡∏ä‡πà‡∏≤ ‡∏à‡πâ‡∏≤‡∏á", "LAW"], "LAW3101": [2, "1", "A", "‡∏≠‡∏≤‡∏ç‡∏≤ 3", "LAW"],
    "LAW3102": [3, "4", "B", "‡∏´‡∏∏‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô", "LAW"], "LAW3103": [3, "1", "B", "‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß", "LAW"],
    "LAW3104": [2, "3", "A", "‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç‡∏®‡∏≤‡∏•", "LAW"], "LAW3105": [3, "1", "B", "‡∏ß‡∏¥.‡πÅ‡∏û‡πà‡∏á 1", "LAW"],
    "LAW3106": [3, "4", "B", "‡∏ß‡∏¥‡∏≠‡∏≤‡∏ç‡∏≤ 1", "LAW"], "LAW3109": [3, "3", "B", "‡∏°‡∏£‡∏î‡∏Å", "LAW"],
    "LAW3110": [2, "1", "A", "‡∏•‡πâ‡∏°‡∏•‡∏∞‡∏•‡∏≤‡∏¢", "LAW"], "LAW3111": [3, "2", "A", "‡∏û‡∏¢‡∏≤‡∏ô", "LAW"],
    "LAW3112": [3, "1", "B", "‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á", "LAW"], "LAW3117": [2, "1", "A", "‡∏õ.‡∏ß‡∏¥‡∏°‡∏´‡∏≤‡∏ä‡∏ô", "LAW"],
    "LAW4101": [2, "1", "A", "‡∏†‡∏≤‡∏©‡∏µ", "LAW"], "LAW4102": [3, "2", "B", "‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°", "LAW"],
    "LAW4103": [3, "4", "A", "‡∏Ñ‡∏î‡∏µ‡πÄ‡∏°‡∏∑‡∏≠‡∏á", "LAW"], "LAW4104": [2, "2", "B", "‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô", "LAW"],
    "LAW4105": [2, "2", "A", "‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û‡∏ó‡∏ô‡∏≤‡∏¢", "LAW"], "LAW4106": [2, "3", "A", "‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡∏ä‡∏ô", "LAW"],
    "LAW4107": [2, "2", "B", "‡∏õ‡∏£‡∏±‡∏ä‡∏ç‡∏≤", "LAW"], "LAW4108": [3, "2", "B", "‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô", "LAW"],
    "LAW4109": [3, "4", "A", "‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏õ‡∏±‡∏ç‡∏ç‡∏≤", "LAW"], "LAW4110": [2, "1", "A", "‡∏Ñ‡πâ‡∏≤‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", "LAW"],
    "LAW3133": [3, "3", "B", "‡∏≠‡∏≤‡∏ä‡∏ç‡∏≤‡∏Å‡∏£", "ELECTIVE"], "LAW3138": [2, "1", "B", "‡πÄ‡∏î‡πá‡∏Å", "ELECTIVE"],
    "LAW4134": [2, "1", "B", "‡∏ó‡∏∞‡πÄ‡∏•", "ELECTIVE"], "LAW4156": [2, "2", "A", "‡∏≠‡∏¥‡πâ‡∏á‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢", "ELECTIVE"]
}

grade_map = {"A": 4.0, "B+": 3.5, "B": 3.0, "C+": 2.5, "C": 2.0, "D+": 1.5, "D": 1.0, "F": 0.0}

st.set_page_config(page_title="Law Exam Slot Planner", layout="wide")

# --- 2. CSS ---
st.markdown("""
    <style>
    header {visibility: hidden;}
    .slot-label {
        background-color: #1e3a8a;
        color: white;
        padding: 5px;
        border-radius: 5px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 5px;
        font-size: 14px;
    }
    .stSelectbox label { display: none; }
    .summary-box {
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 8px;
        background-color: #f8fafc;
    }
    </style>
    """, unsafe_allow_html=True)

st.title("‚öñÔ∏è Law GPA & Exam Planner")

tab1, tab2 = st.tabs(["üìä ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏Å‡∏£‡∏î", "üìÖ ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô (‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏≤‡∏ö‡∏™‡∏≠‡∏ö)"])

# --- TAB 1: GPA ---
with tab1:
    st.info("‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏∞‡∏™‡∏°")
    selected_gpa = []
    for label, cp in {"RAM": "RAM", "LAW": "LAW", "Elective": "ELECTIVE"}.items():
        with st.expander(f"üìÇ {label}", expanded=(cp=="LAW")):
            cat_courses = {k: v for k, v in all_courses_db.items() if v[4] == cp}
            cols = st.columns(4)
            for idx, (code, info) in enumerate(cat_courses.items()):
                with cols[idx % 4]:
                    r = st.columns([1.2, 1])
                    if r[0].checkbox(code, key=f"gpa_c_{code}"):
                        g = r[1].selectbox("G", list(grade_map.keys()), key=f"gpa_s_{code}", label_visibility="collapsed")
                        selected_gpa.append({"credit": info[0], "grade": g})
    if selected_gpa:
        total_creds = sum(d['credit'] for d in selected_gpa)
        total_pts = sum(grade_map[d['grade']] * d['credit'] for d in selected_gpa)
        st.success(f"GPA: {total_pts/total_creds:.2f} | ‡∏£‡∏ß‡∏° {total_creds} ‡∏ô‡∏Å.")

# --- TAB 2: Slot Planning ---
with tab2:
    st.subheader("‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≤‡∏ö‡∏™‡∏≠‡∏ö (1A - 4B)")
    col_y, col_t, col_g = st.columns([1, 1, 1])
    y_sel = col_y.selectbox("‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤", [1, 2, 3, 4], key="sel_y")
    t_sel = col_t.selectbox("‡πÄ‡∏ó‡∏≠‡∏°", ["1", "2", "S"], key="sel_t")
    is_grad = col_g.toggle("üéì ‡∏Ç‡∏≠‡∏à‡∏ö (‡∏•‡∏á‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡πÑ‡∏î‡πâ)", key="is_grad")

    st.divider()
    
    # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Key ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ó‡∏≠‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    term_key = f"Y{y_sel}T{t_sel}"
    slots = ["1A", "1B", "2A", "2B", "3A", "3B", "4A", "4B"]
    total_credits = 0
    final_subjects = []

    # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏•‡πá‡∏≠‡∏ï 4 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
    rows = st.columns(4)
    
    for i, slot_name in enumerate(slots):
        with rows[i % 4]:
            st.markdown(f"<div class='slot-label'>‡∏Ñ‡∏≤‡∏ö‡∏™‡∏≠‡∏ö {slot_name}</div>", unsafe_allow_html=True)
            
            # ‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö‡∏ï‡∏£‡∏á‡∏Ñ‡∏≤‡∏ö‡∏ô‡∏µ‡πâ
            day = slot_name[0]   # "1", "2"
            period = slot_name[1] # "A", "B"
            
            valid_courses = ["-"] + [
                f"{code} | {info[3]}" for code, info in all_courses_db.items() 
                if info[1] == day and info[2] == period
            ]
            
            # ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç NameError ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ term_key ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
            user_choice = st.selectbox(
                f"Select {slot_name}", 
                options=valid_courses, 
                key=f"slot_select_{term_key}_{slot_name}"
            )
            
            if user_choice != "-":
                code = user_choice.split(" | ")[0]
                total_credits += all_courses_db[code][0]
                final_subjects.append(f"{code} ({all_courses_db[code][3]})")
                st.caption(f"‚úÖ {all_courses_db[code][0]} ‡∏ô‡∏Å.")

    st.divider()
    
    # ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
    c1, c2 = st.columns([1, 2])
    with c1:
        limit = 30 if is_grad else (9 if t_sel == "S" else 22)
        st.metric("‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï‡∏£‡∏ß‡∏°", f"{total_credits} / {limit}")
        if total_credits > limit:
            st.error("‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î!")
            
    with c2:
        st.markdown("**‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡πÄ‡∏ó‡∏≠‡∏°‡∏ô‡∏µ‡πâ:**")
        if final_subjects:
            for s in final_subjects:
                st.write(f"- {s}")
        else:
            st.write("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤")

st.markdown("---")
if st.button("üßß ‡πÇ‡∏î‡πÄ‡∏ô‡∏ó‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô"):
    for ext in ["jpg", "jpeg", "png"]:
        if os.path.exists(f"donate.{ext}"):
            st.image(f"donate.{ext}", use_container_width=True)
