import streamlit as st
import os

# --- 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ö (Database ‡∏Å‡∏•‡∏≤‡∏á) ---
all_courses_db = {
    # ‡∏´‡∏°‡∏ß‡∏î RAM
    "RAM1101": [3, "4", "A", "‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢", "RAM"], "RAM1111": [3, "4", "B", "‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© 1", "RAM"],
    "RAM1112": [3, "3", "B", "‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© 2", "RAM"], "RAM1132": [3, "3", "A", "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î", "RAM"],
    "RAM1141": [3, "2", "A", "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û", "RAM"], "RAM1204": [3, "3", "B", "‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î", "RAM"],
    "RAM1213": [3, "3", "A", "‡∏ß‡∏¥‡∏ä‡∏≤ RAM", "RAM"], "RAM1301": [3, "4", "B", "‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏°", "RAM"],
    "RAM1303": [3, "2", "B", "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", "RAM"], "RAM1312": [3, "4", "B", "‡∏ß‡∏¥‡∏ä‡∏≤ RAM", "RAM"],
    # ‡∏´‡∏°‡∏ß‡∏î LAW
    "LAW1101": [2, "2", "A", "‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏°‡∏´‡∏≤‡∏ä‡∏ô", "LAW"], "LAW1102": [2, "4", "A", "‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô", "LAW"],
    "LAW1103": [3, "2", "A", "‡∏ô‡∏¥‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°", "LAW"], "LAW2101": [3, "2", "B", "‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå", "LAW"],
    "LAW2102": [3, "3", "A", "‡∏´‡∏ô‡∏µ‡πâ", "LAW"], "LAW2104": [3, "2", "B", "‡∏£‡∏±‡∏ê‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç", "LAW"],
    "LAW2105": [3, "4", "A", "‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢", "LAW"], "LAW2106": [3, "4", "A", "‡∏≠‡∏≤‡∏ç‡∏≤ 1", "LAW"],
    "LAW2107": [3, "1", "B", "‡∏≠‡∏≤‡∏ç‡∏≤ 2", "LAW"], "LAW2109": [3, "3", "B", "‡∏¢‡∏∑‡∏° ‡∏ù‡∏≤‡∏Å", "LAW"],
    "LAW2110": [2, "1", "B", "‡∏Ñ‡πâ‡∏≥ ‡∏à‡∏≥‡∏ô‡∏≥", "LAW"], "LAW2111": [2, "3", "A", "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô", "LAW"],
    "LAW2112": [2, "4", "B", "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô", "LAW"], "LAW2113": [3, "2", "A", "‡∏ï‡∏±‡πã‡∏ß‡πÄ‡∏á‡∏¥‡∏ô", "LAW"],
    "LAW2108": [2, "1", "A", "‡πÄ‡∏ä‡πà‡∏≤ ‡∏à‡πâ‡∏≤‡∏á", "LAW"], "LAW3101": [2, "1", "A", "‡∏≠‡∏≤‡∏ç‡∏≤ 3", "LAW"],
    "LAW3102": [3, "4", "B", "‡∏´‡∏∏‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô", "LAW"], "LAW3103": [3, "1", "B", "‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß", "LAW"],
    "LAW3104": [2, "3", "A", "‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç‡∏®‡∏≤‡∏•", "LAW"], "LAW3105": [3, "1", "B", "‡∏ß‡∏¥.‡πÅ‡∏û‡πà‡∏á 1", "LAW"],
    "LAW3106": [3, "4", "B", "‡∏ß‡∏¥‡∏≠‡∏≤‡∏ç‡∏≤ 1", "LAW"], "LAW3109": [3, "3", "B", "‡∏°‡∏£‡∏î‡∏Å", "LAW"],
    "LAW3110": [2, "1", "A", "‡∏•‡πâ‡∏°‡∏•‡∏∞‡∏•‡∏≤‡∏¢", "LAW"], "LAW3111": [3, "2", "A", "‡∏û‡∏¢‡∏≤‡∏ô", "LAW"],
    "LAW3112": [3, "1", "B", "‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á", "LAW"], "LAW3117": [2, "1", "A", "‡∏õ.‡∏ß‡∏¥‡∏°‡∏´‡∏≤‡∏ä‡∏ô", "LAW"],
    "LAW4101": [2, "1", "A", "‡∏†‡∏≤‡∏©‡∏µ", "LAW"], "LAW4102": [3, "2", "B", "‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°", "LAW"],
    "LAW4103": [3, "4", "A", "‡∏Ñ‡∏î‡∏µ‡πÄ‡∏°‡∏∑‡∏≠‡∏á", "LAW"], "LAW4104": [2, "2", "B", "‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô", "LAW"],
    "LAW4105": [2, "2", "A", "‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û‡∏ó‡∏ô‡∏≤‡∏¢", "LAW"], "LAW4106": [2, "3", "A", "‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡∏ä‡∏ô", "LAW"],
    "LAW4107": [2, "2", "B", "‡∏õ‡∏£‡∏±‡∏ä‡∏ç‡∏≤", "LAW"], "LAW4108": [3, "2", "B", "‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô", "LAW"],
    "LAW4109": [3, "4", "A", "‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏õ‡∏±‡∏ç‡∏ç‡∏≤", "LAW"], "LAW4110": [2, "1", "A", "‡∏Ñ‡πâ‡∏≤‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", "LAW"],
    # ‡∏´‡∏°‡∏ß‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    "LAW3133": [3, "3", "B", "‡∏≠‡∏≤‡∏ä‡∏ç‡∏≤‡∏Å‡∏£", "ELECTIVE"], "LAW3138": [2, "1", "B", "‡πÄ‡∏î‡πá‡∏Å", "ELECTIVE"],
    "LAW4134": [2, "1", "B", "‡∏ó‡∏∞‡πÄ‡∏•", "ELECTIVE"], "LAW4156": [2, "2", "A", "‡∏≠‡∏¥‡πâ‡∏á‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢", "ELECTIVE"],
    "‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1": [3, "0", "0", "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏£‡∏µ 1", "ELECTIVE"], "‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 2": [3, "0", "0", "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏£‡∏µ 2", "ELECTIVE"]
}

grade_map = {"A": 4.0, "B+": 3.5, "B": 3.0, "C+": 2.5, "C": 2.0, "D+": 1.5, "D": 1.0, "F": 0.0}

st.set_page_config(page_title="GPA Law Pro", layout="wide")

# --- 2. Initialize Session State ---
if "study_plan" not in st.session_state:
    st.session_state.study_plan = {f"‡∏õ‡∏µ {y} ‡πÄ‡∏ó‡∏≠‡∏° {t}": [] for y in range(1, 5) for t in ["1", "2", "S"]}
if "current_term" not in st.session_state:
    st.session_state.current_term = "‡∏õ‡∏µ 1 ‡πÄ‡∏ó‡∏≠‡∏° 1"

# --- 3. CSS ---
st.markdown("""
    <style>
    header {visibility: hidden;}
    .stMainBlockContainer { padding-top: 1.5rem !important; }
    [data-testid="stExpander"] [data-testid="column"] { flex: 1 1 45% !important; min-width: 140px !important; }
    .summary-grid { display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-start; padding: 10px 0; }
    .result-box {
        width: 100px; padding: 8px 4px; border: 2px solid #333; border-radius: 8px;
        text-align: center; background-color: #ffffff !important; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
    }
    .result-box span { font-size: 11px !important; display: block; color: #333 !important; }
    .result-box b { font-size: 20px !important; display: block; color: #d32f2f !important; }
    .header-style { color: #1f77b4; font-weight: bold; font-size: 1.1rem; }
    </style>
    """, unsafe_allow_html=True)

st.title("‚öñÔ∏è Law GPA & Planning Tool")

tab1, tab2 = st.tabs(["üìä ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏Å‡∏£‡∏î (GPA)", "üìÖ ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô"])

# --- TAB 1: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏Å‡∏£‡∏î ---
with tab1:
    st.info("‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡πä‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß")
    selected_gpa = []
    cats = {"‡∏´‡∏°‡∏ß‡∏î RAM": "RAM", "‡∏´‡∏°‡∏ß‡∏î LAW": "LAW", "‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å": "ELECTIVE"}
    
    for label, code_prefix in cats.items():
        with st.expander(f"üìÇ {label}", expanded=(code_prefix == "LAW")):
            cat_courses = {k: v for k, v in all_courses_db.items() if v[4] == code_prefix}
            gpa_cols = st.columns(4)
            for idx, (code, info) in enumerate(cat_courses.items()):
                with gpa_cols[idx % 4]:
                    c_row = st.columns([1.1, 1])
                    if c_row[0].checkbox(f"{code}", key=f"gpa_{code}"):
                        g = c_row[1].selectbox("G", list(grade_map.keys()), key=f"sel_{code}", label_visibility="collapsed")
                        selected_gpa.append({"name": code, "credit": info[0], "grade": g})
    
    if selected_gpa:
        st.divider()
        total_creds = sum(d['credit'] for d in selected_gpa)
        total_points = sum(grade_map[d['grade']] * d['credit'] for d in selected_gpa)
        gpa_score = total_points / total_creds if total_creds > 0 else 0
        st.success(f"### GPA: {gpa_score:.2f} | ‡∏£‡∏ß‡∏° {total_creds} ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï")
        
        # ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
        sum_html = '<div class="summary-grid">'
        for d in selected_gpa:
            sum_html += f'<div class="result-box"><span>{d["name"]}</span><b>{d["grade"]}</b></div>'
        sum_html += '</div>'
        st.markdown(sum_html, unsafe_allow_html=True)

# --- TAB 2: ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Dashboard ‡πÅ‡∏ö‡∏ö‡∏à‡∏¥‡πâ‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ---
with tab2:
    st.subheader("‡∏à‡∏±‡∏î‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏•‡∏á‡∏ã‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏™‡∏≠‡∏ö‡∏ä‡∏ô)")
    col_t1, col_t2 = st.columns([2, 1])
    
    with col_t1:
        st.session_state.current_term = st.selectbox(
            "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ó‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤:", 
            list(st.session_state.study_plan.keys())
        )
    with col_t2:
        is_grad = st.toggle("‡∏Ç‡∏≠‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (30 ‡∏ô‡∏Å. / ‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô)")

    st.divider()
    col_left, col_right = st.columns([1, 1])

    with col_left:
        st.markdown("<p class='header-style'>‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°)</p>", unsafe_allow_html=True)
        used_subs = [item for sublist in st.session_state.study_plan.values() for item in sublist]
        cat = st.radio("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:", ["RAM", "LAW", "ELECTIVE"], horizontal=True)
        
        # ‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
        available_courses = {k: v for k, v in all_courses_db.items() if v[4] == cat and k not in used_subs}
        
        for code, info in available_courses.items():
            exam = f"({info[1]}{info[2]})" if info[1] != "0" else ""
            if st.button(f"ADD: {code} {info[3]} {exam}", key=f"plan_add_{code}"):
                st.session_state.study_plan[st.session_state.current_term].append(code)
                st.rerun()

    with col_right:
        st.markdown(f"<p class='header-style'>‡πÄ‡∏ó‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î: {st.session_state.current_term}</p>", unsafe_allow_html=True)
        current_list = st.session_state.study_plan[st.session_state.current_term]
        
        if not current_list:
            st.write("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤ ‡∏à‡∏¥‡πâ‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢")
        else:
            total_c = 0
            exam_check = {}
            for sub in current_list:
                info = all_courses_db[sub]
                total_c += info[0]
                
                c_sub, c_del = st.columns([5, 1])
                c_sub.write(f"**{sub}** - {info[3]} ({info[1]}{info[2]})")
                if c_del.button("DEL", key=f"plan_del_{sub}"):
                    st.session_state.study_plan[st.session_state.current_term].remove(sub)
                    st.rerun()
                
                # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏≠‡∏ö‡∏ä‡∏ô
                d_code = f"{info[1]}{info[2]}"
                if d_code != "00":
                    if d_code in exam_check:
                        if is_grad: st.warning(f"‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: {sub} ‡∏™‡∏≠‡∏ö‡∏ä‡∏ô‡∏Å‡∏±‡∏ö {exam_check[d_code]}")
                        else: st.error(f"‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏á: {sub} ‡∏™‡∏≠‡∏ö‡∏ä‡∏ô‡∏Å‡∏±‡∏ö {exam_check[d_code]}!")
                    exam_check[d_code] = sub

            max_c = 30 if is_grad else (9 if "‡πÄ‡∏ó‡∏≠‡∏° S" in st.session_state.current_term else 22)
            st.metric("‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï‡∏£‡∏ß‡∏°‡πÄ‡∏ó‡∏≠‡∏°‡∏ô‡∏µ‡πâ", f"{total_c} / {max_c}")
            if total_c > max_c: st.error("‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î!")

    st.divider()
    if st.button("‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Reset)"):
        st.session_state.study_plan = {f"‡∏õ‡∏µ {y} ‡πÄ‡∏ó‡∏≠‡∏° {t}": [] for y in range(1, 5) for t in ["1", "2", "S"]}
        st.rerun()
